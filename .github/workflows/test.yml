name: Test Formulas

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  audit-formulas:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GOCARDLESS_CI_ROBOT_TOKEN }}
        run: |
          # Homebrew is pre-installed on macOS runners
          # Tap this repository
          brew tap gocardless/taps "$GITHUB_WORKSPACE"

      - name: Audit formulas
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GOCARDLESS_CI_ROBOT_TOKEN }}
        run: |
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            echo "Auditing gocardless/taps/$formula_name..."
            # Skip online checks because releases are private and require custom download strategy
            brew audit --skip-style "gocardless/taps/$formula_name" || exit 1
          done

  install-and-test-formulas:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GOCARDLESS_CI_ROBOT_TOKEN }}
        run: |
          # Homebrew is pre-installed on macOS runners
          # Tap this repository
          brew tap gocardless/taps "$GITHUB_WORKSPACE"

      - name: Install and test formulas
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GOCARDLESS_CI_ROBOT_TOKEN }}
        run: |
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            echo "Testing gocardless/taps/$formula_name..."

            # Install from source
            brew install --build-from-source "gocardless/taps/$formula_name" || exit 1

            # Run formula tests
            brew test "gocardless/taps/$formula_name" || exit 1

            # Uninstall to clean up
            brew uninstall "gocardless/taps/$formula_name"
          done

  check-formula-style:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GOCARDLESS_CI_ROBOT_TOKEN }}
        run: |
          # Homebrew is pre-installed on macOS runners
          # Tap this repository
          brew tap gocardless/taps "$GITHUB_WORKSPACE"

      - name: Check formula style
        run: |
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            brew style "gocardless/taps/$formula_name"
          done
